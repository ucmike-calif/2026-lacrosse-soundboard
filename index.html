<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lacrosse Soundboard</title>
  <style>
    :root{
      --bg: #ffffff;
      --text: #111;
      --muted: #555;
      --border: #d9d9d9;

      --green: #0b7a30;
      --greenTint: rgba(11,122,48,0.10);

      --red: #b30000;
      --redTint: rgba(179,0,0,0.10);

      --purple: #5b2d8e;
      --purpleTint: rgba(91,45,142,0.10);

      --btnBg: #fff;
      --btnBorder: #cfcfcf;
      --btnShadow: rgba(0,0,0,0.08);
    }

    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header{
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--border);
    }

    h1{
      margin: 0 0 10px 0;
      font-size: 26px;
      line-height: 1.1;
    }

    .banner{
      width: 100%;
      border-radius: 10px;
      padding: 14px 16px;
      font-weight: 800;
      text-align: center;
      letter-spacing: 1px;
      font-size: 20px;
      color: #fff;
      user-select: none;
    }
    .banner.song{ background: var(--green); }
    .banner.goal{ background: var(--red); }
    .banner.playlist{ background: var(--purple); }

    .tabbtn .playlistText{ color: var(--purple); font-weight: 800; }

    .toolbar{
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .tabbtn, .ctlbtn{
      border: 1px solid var(--btnBorder);
      background: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 2px 8px var(--btnShadow);
    }

    .ctlbtn:disabled{
      opacity: 0.85;
      cursor: default;
    }

    /* Stop button should look like a stop sign */
    #stopBtn{
      background: var(--red);
      color: #fff;
      border-color: rgba(0,0,0,0.10);
      font-weight: 800;
    }

    /* Visual feedback when Stop has been clicked */
    #stopBtn.stopping{
      background: #7f0000;
      border-color: rgba(0,0,0,0.20);
      outline: 2px solid rgba(0,0,0,0.20);
    }

    .tabbtn.active{
      outline: 2px solid rgba(0,0,0,0.06);
    }

    .tabbtn .songsText{ color: var(--green); font-weight: 800; }
    .tabbtn .goalText{ color: var(--red); font-weight: 800; }

    .status{
      padding: 10px 16px 0;
      color: var(--muted);
      font-size: 15px;
      min-height: 22px;
    }

    .gridwrap{
      padding: 12px 16px 16px;
    }
    .grid{
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(6, minmax(130px, 1fr));
    }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: repeat(4, minmax(140px, 1fr)); }
    }
    @media (max-width: 750px){
      .grid{ grid-template-columns: repeat(3, minmax(120px, 1fr)); }
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
    }

    .card{
      border: 1px solid var(--btnBorder);
      border-radius: 14px;
      background: var(--btnBg);
      box-shadow: 0 6px 14px var(--btnShadow);
      padding: 10px;
      user-select: none;
      cursor: pointer;
      position: relative;
      transition: transform 0.05s ease, background 0.2s ease;
    }

    .card.songModeTint{ background: var(--greenTint); }
    .card.playlistModeTint{ background: var(--purpleTint); }
    .card.missing{
      opacity: 0.22;
      filter: grayscale(1);
    }
    .card.missing .num{
      color: #666;
      border-style: dashed;
      background: rgba(225,225,225,0.95);
    }
    .card.missing .name{
      color: #777;
    }
    .card.goalModeTint{ background: var(--redTint); }

    .card:active{ transform: scale(0.985); }

    .card.flash{ outline: 3px solid rgba(0,0,0,0.14); }

    .card.playing{
      outline: 4px solid rgba(0,0,0,0.22);
      box-shadow: 0 10px 20px rgba(0,0,0,0.14);
    }

    .num{
      font-size: 22px;
      font-weight: 900;
      text-align: center;
      padding: 12px 8px;
      border-radius: 10px;
      border: 1px solid var(--btnBorder);
      background: rgba(255,255,255,0.8);
    }

    .name{
      margin-top: 8px;
      text-align: center;
      font-size: 14px;
      color: #222;
      min-height: 18px;
    }

    .confirmbar{
      /* Top, under the buttons */
      position: sticky;
      top: 0;
      padding: 10px 12px;
      background: rgba(255,255,255,0.97);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      display: none;
      z-index: 999;
      backdrop-filter: blur(8px);
    }

    .confirmbar-inner{
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .confirmtext{
      flex: 1 1 260px;
      font-size: 16px;
      font-weight: 700;
      color: #111;
    }

    .confirmbtn{
      border: 1px solid var(--btnBorder);
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 8px var(--btnShadow);
      background: #fff;
      user-select: none;
    }

    .confirmbtn.cancel{ color: #333; }
    .confirmbtn.go{
      background: var(--red);
      color: #fff;
      border-color: rgba(0,0,0,0.08);
      font-weight: 800;
    }
  </style>
</head>

<body>
  <header>
    <h1>Lacrosse Soundboard</h1>
    <div id="modeBanner" class="banner song">SONG MODE</div>
  </header>

  <div class="toolbar">
    <button id="songsTab" class="tabbtn active" type="button"><span class="songsText">Songs</span></button>
    <button id="goalTab" class="tabbtn" type="button"><span class="goalText">Goal Call</span></button>
    <button id="playlistTab" class="tabbtn" type="button"><span class="playlistText">Playlist</span></button>
    <button id="stopBtn" class="ctlbtn" type="button">Stop (Fade)</button>
  </div>

  <!-- Goal confirm banner (shows only in Goal mode) -->
  <div id="confirmBar" class="confirmbar">
    <div class="confirmbar-inner">
      <div id="confirmText" class="confirmtext">Confirm GOAL call:</div>
      <button id="confirmCancel" class="confirmbtn cancel" type="button">Cancel</button>
      <button id="confirmGo" class="confirmbtn go" type="button">PLAY GOAL</button>
    </div>
  </div>

  <div id="status" class="status"></div>

  <div class="gridwrap">
    <div id="grid" class="grid"></div>
  </div>

  <script>
    /*****************************************************************
     * EDIT HERE: Folder structure + roster + file naming
     *****************************************************************/
    const AUDIO_BASE = "audio"; // repo path: /audio/...

    // Fade tuning
    // Goal: no "cliff" — smooth, predictable tail.
    const FADE_TOTAL_SEC = 4.0; // total fade length
    const FADE_HOLD_SEC  = 1.0; // stays full volume for first part of fade

    // Players missing SONG files (easy to undo: remove numbers from this set)
    const MISSING_SONG_NUMS = new Set([2, 4, 5, 7, 8, 10, 12, 13, 15, 25, 30]);

    const players = [
      { num: 1,  name: "Roshan Royai",                songFile: "01_Roshan_Royai.mp3",                 goalFile: "01_Roshan_Royai_Goal.mp3" },
      { num: 2,  name: "Hayden Nicholas",             songFile: "02_Hayden_Nicholas.mp3",              goalFile: "02_Hayden_Nicholas_Goal.mp3" },
      { num: 3,  name: "Corinne Negrete",             songFile: "03_Corinne_Negrete.mp3",              goalFile: "03_Corinne_Negrete_Goal.mp3" },
      { num: 4,  name: "Ava Thompson",                songFile: "04_Ava_Thompson.mp3",                 goalFile: "04_Ava_Thompson_Goal.mp3" },
      { num: 5,  name: "Ceili Dwyer",                 songFile: "05_Ceili_Dwyer.mp3",                  goalFile: "05_Ceili_Dwyer_Goal.mp3" },
      { num: 6,  name: "Ava Ahern",                   songFile: "06_Ava_Ahern.mp3",                    goalFile: "06_Ava_Ahern_Goal.mp3" },
      { num: 7,  name: "Hazel Toombs",                songFile: "07_Hazel_Toombs.mp3",                 goalFile: "07_Hazel_Toombs_Goal.mp3" },
      { num: 8,  name: "Beatriz Mark-Constantino",    songFile: "08_Beatriz_Mark-Constantino.mp3",     goalFile: "08_Beatriz_Mark-Constantino_Goal.mp3" },
      { num: 9,  name: "Sophia Sanchez",              songFile: "09_Sophia_Sanchez.mp3",               goalFile: "09_Sophia_Sanchez_Goal.mp3" },
      { num: 10, name: "Calyn Foley",                 songFile: "10_Calyn_Foley.mp3",                  goalFile: "10_Calyn_Foley_Goal.mp3" },
      { num: 11, name: "Marisa Knight",               songFile: "11_Marisa_Knight.mp3",                goalFile: "11_Marisa_Knight_Goal.mp3" },
      { num: 12, name: "Samina Mcleod",               songFile: "12_Samina_Mcleod.mp3",                goalFile: "12_Samina_Mcleod_Goal.mp3" },
      { num: 13, name: "Molly Cotton",                songFile: "13_Molly_Cotton.mp3",                 goalFile: "13_Molly_Cotton_Goal.mp3" },
      { num: 15, name: "Sophia Rizzo",                songFile: "15_Sophia_Rizzo.mp3",                 goalFile: "15_Sophia_Rizzo_Goal.mp3" },
      { num: 18, name: "Danika Reginato",             songFile: "18_Danika_Reginato.mp3",              goalFile: "18_Danika_Reginato_Goal.mp3" },
      { num: 20, name: "Ava Keane",                   songFile: "20_Ava_Keane.mp3",                    goalFile: "20_Ava_Keane_Goal.mp3" },
      { num: 25, name: "Isabella Watson",             songFile: "25_Isabella_Watson.mp3",              goalFile: "25_Isabella_Watson_Goal.mp3" },
      { num: 27, name: "Amanda Reed",                 songFile: "27_Amanda_Reed.mp3",                  goalFile: "27_Amanda_Reed_Goal.mp3" },
      { num: 30, name: "Claire Junge",                songFile: "30_Claire_Junge.mp3",                 goalFile: "30_Claire_Junge_Goal.mp3" },
      { num: 31, name: "Ava Reed",                    songFile: "31_Ava_Reed.mp3",                     goalFile: "31_Ava_Reed_Goal.mp3" },
    ];

    const extras = [
      { key: "Anthem", labelTop: "Anthem", labelBottom: "National Anthem", songFile: "extras/Anthem.mp3", goalFile: "extras/Anthem_Goal.mp3" },
      { key: "TBD 1", labelTop: "Oh Yeah", labelBottom: "After Nat'l Anthem", songFile: "extras/TBD_1.mp3", goalFile: "extras/TBD_1_Goal.mp3" },
      { key: "TBD 2", labelTop: "Neigh-Gallop", labelBottom: "Post-Goal", songFile: "extras/TBD_2.mp3", goalFile: "extras/TBD_2_Goal.mp3" },
      { key: "TBD 3", labelTop: "Mustang Sally", labelBottom: "After a Win", songFile: "extras/TBD_3.mp3", goalFile: "extras/TBD_3_Goal.mp3" },
    ];

    /*****************************************************************
     * App state
     *****************************************************************/
    const Mode = Object.freeze({ SONGS: "songs", GOAL: "goal", PLAYLIST: "playlist" });

    const playlist = [
      { title: "family ties",                    artist: "Baby Keem & Kendrick Lamar",          file: "family_ties.mp3" },
      { title: "Flex Up",                         artist: "Lil Yachty, Future & Playboi Carti",  file: "flex_up.mp3" },
      { title: "Like That",                       artist: "Future, Metro Boomin & Kendrick Lamar",file: "like_that.mp3" },
      { title: "Parking Lot",                     artist: "Mustard & Travis Scott",              file: "parking_lot.mp3" },
      { title: "Family Matters",                  artist: "Drake",                               file: "family_matters.mp3" },
      { title: "It's Up",                         artist: "Drake, Young Thug & 21 Savage",       file: "its_up.mp3" },
      { title: "BANDIT",                          artist: "Don Toliver",                         file: "bandit.mp3" },
      { title: "squabble up",                     artist: "Kendrick Lamar",                      file: "squabble_up.mp3" },
      { title: "Mmhmm",                           artist: "BigXthaPlug",                         file: "mmhmm.mp3" },
      { title: "Surround Sound",                  artist: "JID feat. 21 Savage",                 file: "surround_sound.mp3" },
      { title: "Praise The Lord (Da Shine)",      artist: "A$AP Rocky",                          file: "praise_the_lord.mp3" },
      { title: "FIELD TRIP",                      artist: "¥$, Kanye West & Ty Dolla $ign",      file: "field_trip.mp3" },
      { title: "Back On My BS",                   artist: "BigXthaPlug",                         file: "back_on_my_bs.mp3" },
      { title: "How Soon Is Now?",                artist: "The Smiths",                           file: "how_soon_is_now.mp3" },
      { title: "Rocket Fuel",                     artist: "DJ Shadow feat. De La Soul",           file: "rocket_fuel.mp3" },
      { title: "So What'cha Want",                artist: "Beastie Boys",                         file: "so_whatcha_want.mp3" },
      { title: "Turn Down for What",              artist: "DJ Snake & Lil Jon",                   file: "turn_down_for_what.mp3" },
      { title: "It Takes Two",                    artist: "Rob Base & DJ EZ Rock",                file: "it_takes_two.mp3" },
      { title: "Gonna Make You Sweat",            artist: "C+C Music Factory",                    file: "gonna_make_you_sweat.mp3" },
      { title: "The Power",                       artist: "Snap!",                                file: "the_power.mp3" },
      { title: "Uptown Funk",                     artist: "Mark Ronson feat. Bruno Mars",         file: "uptown_funk.mp3" },
      { title: "out of sight",                    artist: "Run The Jewels feat. 2 Chainz",        file: "out_of_sight.mp3" },
      { title: "ooh la la",                       artist: "Run The Jewels feat. DJ Premier",      file: "ooh_la_la.mp3" },
      { title: "Seven Nation Army",               artist: "The White Stripes",                    file: "seven_nation_army.mp3" },
      { title: "Banana Clipper",                  artist: "Run The Jewels & El-P",                file: "banana_clipper.mp3" },
      { title: "JU$T",                            artist: "Run The Jewels feat. Zack de la Rocha",file: "just.mp3" },
      { title: "Get Ready",                       artist: "2 Unlimited",                          file: "get_ready.mp3" },
      { title: "Sirius",                          artist: "The Alan Parsons Project",             file: "sirius.mp3" },
      { title: "Strike It Up",                    artist: "Black Box",                            file: "strike_it_up.mp3" },
      { title: "Thunderstruck",                   artist: "AC/DC",                                file: "thunderstruck.mp3" },
      { title: "Back In Black",                   artist: "AC/DC",                                file: "back_in_black.mp3" },
      { title: "Madness",                         artist: "Muse",                                 file: "madness.mp3" },
      { title: "Royals",                          artist: "Lorde",                                file: "royals.mp3" },
      { title: "bad guy",                         artist: "Billie Eilish",                        file: "bad_guy.mp3" },
      { title: "Right Here, Right Now",           artist: "Fatboy Slim",                          file: "right_here_right_now.mp3" },
      { title: "Situation",                       artist: "Yaz",                                  file: "situation.mp3" },
    ];
    let currentMode = Mode.SONGS;

    let currentButtonEl = null;
    let lastPlayed = null;   // { src, label }
    let pendingGoal = null;  // { src, label, buttonEl }

    // Hybrid playback: HTMLAudioElement routed through Web Audio GainNode for Safari-safe output + smooth fades
    let currentAudioEl = null;
    let audioCtx = null;
    let currentMediaNode = null;
    let currentGainNode = null;
    let fadeTimer = null;
    let audioUnlocked = false;

    const grid = document.getElementById("grid");
    const status = document.getElementById("status");
    const modeBanner = document.getElementById("modeBanner");

    const songsTab    = document.getElementById("songsTab");
    const goalTab     = document.getElementById("goalTab");
    const playlistTab = document.getElementById("playlistTab");
    const stopBtn     = document.getElementById("stopBtn");

    const confirmBar = document.getElementById("confirmBar");
    const confirmText = document.getElementById("confirmText");
    const confirmCancel = document.getElementById("confirmCancel");
    const confirmGo = document.getElementById("confirmGo");

    function setStatus(text){ status.textContent = text || ""; }

    function flashButton(el){
      if(!el) return;
      el.classList.add("flash");
      setTimeout(() => el.classList.remove("flash"), 140);
    }

    function clearPlayingHighlight(){
      if(currentButtonEl){
        currentButtonEl.classList.remove("playing");
        currentButtonEl = null;
      }
    }

    function stopImmediate(){
      if (fadeTimer){
        clearInterval(fadeTimer);
        fadeTimer = null;
      }

      // Stop audio element
      if (currentAudioEl){
        try { currentAudioEl.pause(); } catch(e){}
        try { currentAudioEl.currentTime = 0; } catch(e){}
      }

      // Disconnect Web Audio nodes
      if (currentMediaNode){
        try { currentMediaNode.disconnect(); } catch(e){}
        currentMediaNode = null;
      }
      if (currentGainNode){
        try { currentGainNode.disconnect(); } catch(e){}
        currentGainNode = null;
      }

      currentAudioEl = null;
      clearPlayingHighlight();
      setStatus("");
    }

    function ensureAudioContext(){
      if (!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioCtx;
    }

    async function unlockAudio(){
      const ctx = ensureAudioContext();
      if (ctx.state === "suspended"){
        try { await ctx.resume(); } catch(e){}
      }
      if (audioUnlocked) return;
      try {
        const buffer = ctx.createBuffer(1, 1, ctx.sampleRate);
        const src = ctx.createBufferSource();
        src.buffer = buffer;
        src.connect(ctx.destination);
        src.start(0);
      } catch(e){}
      audioUnlocked = true;
    }

    function stopWithFade(){
      if (!currentAudioEl){
        stopImmediate();
        return;
      }

      if (fadeTimer){
        clearInterval(fadeTimer);
        fadeTimer = null;
      }

      const audio = currentAudioEl;
      const totalMs = Math.max(300, Math.round(FADE_TOTAL_SEC * 1000));
      const holdMs  = Math.max(0, Math.min(totalMs - 50, Math.round(FADE_HOLD_SEC * 1000)));
      const startTs = performance.now();

      // Prefer GainNode fade when available
      const hasGain = !!(currentGainNode && audioCtx);
      const startGain = hasGain ? (currentGainNode.gain.value || 1) : (audio.volume ?? 1);

      fadeTimer = setInterval(() => {
        const t = performance.now() - startTs;

        if (t <= holdMs){
          if (hasGain) currentGainNode.gain.value = startGain;
          else audio.volume = startGain;
          return;
        }

        const p = Math.min(1, (t - holdMs) / Math.max(1, (totalMs - holdMs)));
        // Super-smooth curve: smoothstep -> cosine
        const smooth = p * p * (3 - 2 * p);
        const cosine = 0.5 - 0.5 * Math.cos(Math.PI * smooth);
        const v = Math.max(0.0001, startGain * (1 - cosine));

        if (hasGain) currentGainNode.gain.value = v;
        else audio.volume = v;

        if (p >= 1){
          clearInterval(fadeTimer);
          fadeTimer = null;
          stopImmediate();
        }
      }, 33);
    }

    async function playAudio(src, label, buttonEl){
      stopImmediate();

      // Ensure Safari output is unlocked on a user gesture
      await unlockAudio();
      const ctx = ensureAudioContext();
      if (ctx.state === "suspended"){
        try { await ctx.resume(); } catch(e){}
      }

      const audio = new Audio(src);
      audio.preload = "auto";
      audio.volume = 1.0;
      audio.muted = false;
      audio.playsInline = true;
      currentAudioEl = audio;

      // Helpful error reporting (Safari will throw decode/MIME issues here)
      audio.addEventListener("error", () => {
        const code = audio?.error?.code;
        setStatus(`Audio error for ${src} (code ${code || "?"})`);
        clearPlayingHighlight();
      });

      // Route through Web Audio GainNode so fades are consistent
      try {
        currentGainNode = ctx.createGain();
        currentGainNode.gain.setValueAtTime(1.0, ctx.currentTime);
        currentGainNode.connect(ctx.destination);

        currentMediaNode = ctx.createMediaElementSource(audio);
        currentMediaNode.connect(currentGainNode);
      } catch(e){
        // If MediaElementSource fails, fall back to plain audio element
        currentMediaNode = null;
        currentGainNode = null;
      }

      if (buttonEl){
        currentButtonEl = buttonEl;
        buttonEl.classList.add("playing");
      }

      setStatus(`Loading: ${label}`);

      audio.addEventListener("ended", () => {
        if (currentAudioEl === audio){
          stopImmediate();
        }
      });

      try {
        await audio.play();
        lastPlayed = { src, label };
        setStatus(`Playing: ${label}`);
      } catch (err){
        console.error("PLAY ERROR:", err);
        setStatus(`Playback blocked: tap again (${err?.name || "error"})`);
      }
    }

    function showConfirmBar(text){
      confirmText.textContent = text;
      confirmBar.style.display = "block";
    }

    function hideConfirmBar(){
      confirmBar.style.display = "none";
      pendingGoal = null;
    }

    function setMode(mode){
      currentMode = mode;

      if(mode === Mode.SONGS){
        modeBanner.textContent = "SONG MODE";
        modeBanner.className = "banner song";
        songsTab.classList.add("active");
        goalTab.classList.remove("active");
        playlistTab.classList.remove("active");
        hideConfirmBar();
      } else if(mode === Mode.GOAL){
        modeBanner.textContent = "GOAL MODE";
        modeBanner.className = "banner goal";
        goalTab.classList.add("active");
        songsTab.classList.remove("active");
        playlistTab.classList.remove("active");
      } else {
        modeBanner.textContent = "PLAYLIST MODE";
        modeBanner.className = "banner playlist";
        playlistTab.classList.add("active");
        songsTab.classList.remove("active");
        goalTab.classList.remove("active");
        hideConfirmBar();
      }

      renderGrid();
      setStatus("");
    }

    function makeCard({ top, bottom, isMissing, onClick }){
      const card = document.createElement("div");
      card.className = "card";

      if(currentMode === Mode.SONGS)    card.classList.add("songModeTint");
      if(currentMode === Mode.GOAL)     card.classList.add("goalModeTint");
      if(currentMode === Mode.PLAYLIST) card.classList.add("playlistModeTint");
      if(isMissing) card.classList.add("missing");

      const num = document.createElement("div");
      num.className = "num";
      num.textContent = top;

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = bottom;

      card.appendChild(num);
      card.appendChild(name);

      card.addEventListener("click", () => {
        flashButton(card);
        onClick(card);
      });

      return card;
    }

    function renderGrid(){
      grid.innerHTML = "";

      if(currentMode === Mode.PLAYLIST){
        for(const s of playlist){
          const src = `${AUDIO_BASE}/playlist/${s.file}`;
          const label = `${s.title} — ${s.artist}`;
          const card = makeCard({
            top: s.title,
            bottom: s.artist,
            isMissing: false,
            onClick: (el) => { playAudio(src, label, el); }
          });
          grid.appendChild(card);
        }
        return;
      }

      for(const p of players){
        const songSrc = `${AUDIO_BASE}/songs/${p.songFile}`;
        const goalSrc = `${AUDIO_BASE}/goals/${p.goalFile}`;
        const label = `#${p.num} ${p.name}`;

        const isMissing = MISSING_SONG_NUMS.has(p.num);
        const displayNum = isMissing ? `-${p.num}-` : String(p.num);

        const card = makeCard({
          top: displayNum,
          bottom: p.name,
          isMissing,
          onClick: (el) => {
            if(currentMode === Mode.SONGS){
              playAudio(songSrc, label, el);
            } else {
              pendingGoal = { src: goalSrc, label: `Confirm GOAL call: ${label}`, buttonEl: el };
              showConfirmBar(pendingGoal.label);
            }
          }
        });

        grid.appendChild(card);
      }

      for(const x of extras){
        const songSrc = `${AUDIO_BASE}/songs/${x.songFile}`;
        const goalSrc = `${AUDIO_BASE}/goals/${x.goalFile}`;
        const label = x.labelBottom ? `${x.labelBottom}` : x.labelTop;

        const card = makeCard({ top: x.labelTop,
          bottom: x.labelBottom || "",
          onClick: (el) => {
            if(currentMode === Mode.SONGS){
              playAudio(songSrc, label, el);
            } else {
              pendingGoal = { src: goalSrc, label: `Confirm GOAL call: ${label}`, buttonEl: el };
              showConfirmBar(pendingGoal.label);
            }
          }
        });

        grid.appendChild(card);
      }
    }

    // Controls
    songsTab.addEventListener("click",    () => setMode(Mode.SONGS));
    goalTab.addEventListener("click",     () => setMode(Mode.GOAL));
    playlistTab.addEventListener("click", () => setMode(Mode.PLAYLIST));

    stopBtn.addEventListener("click", () => {
      // Make it obvious the click registered
      const originalText = stopBtn.textContent;
      stopBtn.classList.add("stopping");
      stopBtn.textContent = "Stopping…";
      stopBtn.disabled = true;
      setStatus("Stopping…");

      stopWithFade();
      hideConfirmBar();

      const ms = Math.ceil(Math.max(0.5, FADE_TOTAL_SEC) * 1000) + 250;
      setTimeout(() => {
        stopBtn.classList.remove("stopping");
        stopBtn.textContent = originalText;
        stopBtn.disabled = false;
      }, ms);
    });

    confirmCancel.addEventListener("click", () => {
      hideConfirmBar();
      setStatus("");
    });

    confirmGo.addEventListener("click", () => {
      if(!pendingGoal) return;
      const { src, label, buttonEl } = pendingGoal;
      hideConfirmBar();
      playAudio(src, label.replace("Confirm ", ""), buttonEl);
    });

    // Initial render
    renderGrid();
    setMode(Mode.SONGS);
  </script>
</body>
</html>